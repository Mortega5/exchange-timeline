<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-button/paper-button.html">


<!--
An element providing the interface for any site of exchanges

Example:
```
<exchange-timeline access_token="user_access_token" key="your_app_key"
site="stackoverflow.com">
</exchange-timeline>
```
Custom property | Description | Default
----------------|-------------|----------
`--exchange-timeline-width` | Width of the element. | `650px`
`--exchange-timeline-height` | Height of the element. | `400px`
`--exchange-timeline-font-family` | Font type of the element. | `Roboto`
`--exchange-timeline-header-color` | Color of the header  | `--paper-brown-800`
`--exchange-timeline-header` | Mixin applied to the header | `{}`
`--exchange-timeline-title-height` | Height of the logo img | `45px`
`--exchange-timeline-title-width` | Width of the logo img | `200px`


@group Timeline Elements
@element exchange-timeline
@demo demo/index.html
@hero stackoverflow-icon.png
-->
<dom-module id="exchange-timeline">

  <template>
    <style is="custom-style">
      :host {
        display: block;
        width: var(--exchange-timeline-width, 650px);
        height: var(--exchange-timeline-height, 400px);
        font-family: var(--exchange-timeline-font-family, Roboto)
      }
      #panel{
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
        background-color: var(--paper-grey-200);
        border-radius: 2px;
      }
      #panel .paper-header {
        background-color: var(--exchange-timeline-header-color, --paper-brown-800);
        color: white;
        padding:5px 8px;
        @apply(--exchange-timeline-header)
          }
      #panel .paper-header .title{
        background: url('image/se-logo.png') no-repeat;
        background-size: contain;
        height: var(--exchange-timeline-title-height, 45px);
        width: var(--exchange-timeline-title-width, 200px);
        margin:auto 0px;
      }
      #panel .paper-header .searchBar {
        --paper-input-container-color: #eee;
        --paper-input-container-input: {
          color: #eee;
        }
        position:absolute;
        top:0;
        left:0;
        right: 0;
        height: var(--exchange-timeline-title-height);
        background-color: var(--paper-brown-800);
        z-index:1000;
      }
      paper-icon-button[prefix] {
        color: black;
      }
      #panel .content {
        margin:15px 8px;
      }
      #panel .post {
        padding:6px 8px;
        background-color:white;        
      }
      .status {
        min-width: 38px;
        height: 38px;
        margin:auto;
        margin-right: 10px;
        padding: 5px;
        text-align: center;
        font-size:10px;
      }
      .status p {
        margin:auto;
      }
      .answer {
        background-color: #75845c;
      }
      .answer[answered] {
        color:gold;
      }
      .answer[count="0"] {
        background-color:inherit;
      }
      .postInfo .title {
        font-size: 14px;
        margin-bottom:20px;
      }
      .additionalInfo{
        font-size: 10px;
        max-height: 16px;
        overflow-y: hidden;
      }
      .additionalInfo .tag {
        padding:3px;
        background-color: #e1ecf4;
        color: #39739d;
        display: inline-block;
      }
      .additionalInfo .tag:hover {
        background-color:#dae7f1;
        cursor:pointer;
      }
      a {
        text-decoration: none;
      }
      .link {
        color: #005999

      }
      .link:hover {
        color: #07c;
      }
      p {
        margin:auto;
      }
      /* No funcionan las medias queries porque no se aplican sobre el host sino sobre toda la pantalla
      * utilizar toggleClass(nombreClase, booleano, [nodo]) para modificar en funcion del tamaÃ±o
      */
      @media screen (max-width: 500px){
        .votes, .views, .time > p > span{
          display: none !important;
        }
      }
      paper-tabs{
        height: 40px;
        font-size: 12px;
        --paper-tabs-selection-bar-color: var(--paper-orange-700);
      }
      paper-tab {
        --paper-tab-ink: var(--paper-blue-700);
      }
      .loadmore paper-material{
        margin-bottom: 15px;
        background-color: var(--paper-brown-300);
      }
      .loadmore paper-material:hover {
        background-color: var(--paper-brown-400);

      }
      #panel .content.error .post {
        padding:25px 8px;
      }
    </style>

    <iron-ajax
               url="{{_requestEventsUrl}}"
               params="{{_requestEventsParams}}"
               handle-as="json"
               on-response="_handlerRequestEvent"
               on-error="_handlerRequestError"
               id="requestEvent">

    </iron-ajax>
    <iron-ajax url="{{_requestEventsUrl}}"
               params="{{_requestRefreshParams}}"
               handle-as="json"
               on-response="_handlerRefreshEvent"
               on-error="_handlerRequestError"
               id="refreshEvent"
               >
    </iron-ajax>
    <iron-ajax url="{{_requestEventsUrl}}"
               params="{{_requestLoadmoreParams}}"
               handle-as="json"
               on-response="_handlerLoadmoreEvent"
               on-error="_handlerRequestError"
               id="loadmoreEvent"
               >
    </iron-ajax>
    <paper-header-panel id="panel" mode="waterfall" class="blue">
      <div class="paper-header horizontal layout">
        <div class="title flex"></div>
        <paper-input hidden label="search tags (separate them with whitespaces)" class="flex searchBar" id="searchBar" no-label-float value="{{filterBy::bind-value-changed}}" on-keyup="_filterBy" on-blur="closeSearch">
          <paper-icon-button icon="search" on-click="_filterBy" prefix></paper-icon-button>
        </paper-input>
        <paper-icon-button icon="search" on-click="openSearch"></paper-icon-button>
        <!--        <div><paper-icon-button icon="refresh" on-click="refresh"></paper-icon-button></div>-->
      </div>
      <paper-tabs selected="{{tabSelected}}">
        <paper-tab>Last General Questions</paper-tab>
        <paper-tab>Your Questions</paper-tab>
      </paper-tabs>
      <!-- Check if an error happened -->
      <template is="dom-if" if="{{_compareTo(request_error, 'false')}}">
        <!-- CONTENT INFO-->
        <template is="dom-repeat" items="{{events}}">
          <paper-material elevation=1 class="content">
            <div class="post horizontal layout">
              <!-- VOTES -->
              <div class="votes status vertical center-justified layout">
                <p>{{item.score}}</p>
                <p>votes</p>
              </div>
              <!-- ANSWERS -->
              <div count$="{{item.answer_count}}" answered$="{{item.is_answered}}" class="answer status vertical center-justified layout">
                <p>{{item.answer_count}}</p>
                <p>answer</p>
              </div>
              <!-- VIEWS -->
              <div class="views status vertical center-justified layout">
                <p>{{item.view_count}}</p>
                <p>views</p>
              </div>
              <!-- POSTINFO -->
              <div class="postInfo vertical layout flex">
                <!-- TITLE -->
                <div class="title flex">
                  <a href="{{item.link}}" target="_blank" class="link">{{_decode_utf8(item.title)}}</a>
                </div>
                <!-- TAGS AND TIME -->
                <div class="additionalInfo horizontal layout">
                  <div class="tags flex">
                    <template is="dom-repeat" items="{{item.tags}}">
                      <span class="link tag">{{item}}</span>
                    </template>
                  </div>
                  <div class="time">
                    <p>{{item.date}}
                      <a href="{{item.owner.link}}" class="link" target="_blank"> {{_decode_utf8(item.owner.display_name)}}</a >
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </paper-material>
        </template>
        <template is="dom-if" if="{{_compareTo(events.length, 0)}}">
          <paper-material elevation=1 class="content loadmore">
            <div class="post vertical layout" id="not_found">
              <p>Opss!! There are not results for <b>{{not_found}}</b> tag[s].</p> 
              <p>Try it with other[s]</p>
            </div>
          </paper-material>
        </template>
        <!-- Show more button -->
        <template is="dom-if" if="{{has_more}}">
          <div class="horizontal center-justified layout loadmore" id="loadmore">
            <paper-material elevation="2">
              <paper-button on-click="loadmore">Load More</paper-button>
            </paper-material>
          </div>
        </template>
      </template> <!-- /Check error -->
      <template is="dom-if" if="{{request_error}}">
        <paper-material elevation=1 class="content error">
          <div class="post vertical center layout" id="error">
            <p>An error ocurred. Plase try it later</p> 
            <p>Sorry for the inconveniences</p>
          </div>
        </paper-material>
      </template>
    </paper-header-panel>
  </template>


</dom-module>

<script>

  Polymer({

    is: 'exchange-timeline',

    properties: {

      /**
       * `access_token` that permit read information about the user. 
       */
      access_token: {
        type: String,
        reflectToAttribute: true
      },

      /**
        * `key` is your app key on Stack Exchange. 
        */
      key: {
        type: String,
        reflectToAttribute: true
      },
      /**
        * `site` where the timeline will get information. E.g: stackoverflow.com
        */
      site: {
        type:String,
        reflectToAttribute: true
      },

      /**
        * is the url where will get information. It is dependent
        * of `tabSelected`
        */
      _requestEventsUrl: {
        type: String,
        computed: "_composeRequestUrl(tabSelected)"
      },

      /**
        * compose the request param when it will get information
        * about the user
        */
      _requestEventsParams: {
        type: Object,
        computed: "_composeRequestParams(access_token, key, site, filterBy)"
      },

      /**
        * compose the refresh params when the user want refresh the information
        * NOTE (it is not working yet)
        */
      _requestRefreshParams: {
        type: Object,
        computed: "_composeRefreshParams(access_token, key, site, filterBy, first_request)"
      },

      /**
        * compose the refresh params when the user want load more data.
        */
      _requestLoadmoreParams: {
        type: Object,
        computed: "_composeLoadmoreParams(access_token, key, site, filterBy, first_request)"
      },

      /**
        * Filter the questions. 
        */

      filterBy: {
        type: String,
        value: ""
      },
      /*
       * Indicate that tab is selected.
       * 
       *  0: general or 1: your questions
       */
      tabSelected: {
        type: Number,
        value: 0,
        observer: "_requestNewContent" 
      },
      request_error: {
        type: Boolean,
        value: false
      }

    },

    // Element Lifecycle

    ready: function() {
      if(this._requestEventsParams){
        this.$.panel.style.cursor = "wait";
        this.$.requestEvent.generateRequest();
      }
    },

    /**
     * The `exchange-timeline-eventsReady` event is fired whenever new events are loaded.
     *
     * @event exchange-timeline-eventsReady
     * @detail {{sound: String}} 
     */

    /**
      * Handler the questions response.
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerRequestEvent: function(event, detail){
      this.$.panel.style.cursor = "";
      this.fire("exchange-timeline-eventsReady", detail);
      this.request_error = false;
      // set new events
      this.events = detail.response.items;
      // Check if there are more questions
      this.has_more = detail.response.has_more;
      // Save the first request timestamp. It will be used for refresh.
      this.first_request = detail.response.items[0].last_activity_date;
      // Save the last request timestamp. It will be used for load more events. 
      this.last_request = detail.response.items[detail.response.items.length - 1].last_activity_date;
      // If there're no matches, store the filter value
      if (this.events.length === 0) {
        this.not_found = this.filterBy;
      }
      // Change timestamp to human readable
      this._changeTime();
    },

    _handlerRequestError: function(event, detail) {
      this.$.panel.style.cursor = "";
      this.fire("exchange-timeline-errorRequest", {detail:detail});
      this.request_error = true; 
    },

    /**
      * Refresh the information showed in the timeline. It recalculate
      * the time field and it add the new post 
      */
    refresh: function(){
      this.$.panel.style.cursor = "wait";
      this.$.refreshEvent.generateRequest();
    },

    /**
      * Request more data to the API and show it in the timeline.
      */
    loadmore: function(){
      if (this.has_more) {
        this.$.panel.style.cursor = "wait";
        this.$.loadmoreEvent.generateRequest();
      }
    },

    /**
      * Handler the refresh response.
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerRefreshEvent: function(event, detail) {
      this.request_error = false;
      this.$.panel.style.cursor = "";

      var listEvents = detail.response.items;
      if (listEvents) {
        this.first_request = listEvents[0].last_activity_date;
        for (var i = listEvents.length - 1; i >= 0;i--) {
          this.unshift('events', listEvents[i]);
        }
      }
      this._changeTime();
    },

    /**
      * Handler the load more response.
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerLoadmoreEvent: function(event, detail) {
      this.request_error = false;
      this.$.panel.style.cursor = "";
      this.last_request = detail.response.items[0].last_activity_date;
      for (var i = 0; i < detail.response.items.length;i++) {
        this.push('events', detail.response.items[i]);
      }
      this._changeTime();
    },

    /**
      * Create a object with the params needed to request new questions
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @return {object} "{access_token:"value", key: "value", site: "value",
      *                   sort:"activity", order:"desc"}"
      */
    _composeRequestParams: function(access_token, key, site, filterBy) {
      var params = {access_token: access_token, key: key, site: site,
                    sort:"activity", order:"desc"};
      if (filterBy){
        params.tagged =filterBy.replace(/\s/g, ";");
      }
      return params;    },

    /**
      * Choose the endpoint depend on the tab selected.
      * @param {Number} selected Tab number selected.
      * @return {string}  Endpoint where it must request the data.
      */
    _composeRequestUrl: function(selected) {
      return selected == 0 ? "https://api.stackexchange.com/2.2/questions": "https://api.stackexchange.com/2.2/me/questions"
    },

    /**
      * Create a object with the params needed to request refresh
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @param {string} first_request Timestamp of the first element in the timeline.
      * @return {object} "{access_token:"value", key: "value", site: "value",
      *                   sort:"activity", order:"desc", [tagged: "filterBy"]}"
      */
    _composeRefreshParams: function(access_token, key, site, filterBy, first_request){
      var params = {access_token: access_token, key: key, site: site,
                    sort:"activity", order:"desc",
                    fromdate: first_request, todate: Math.ceil(new Date().getTime()/1000), pagesize:100};
      if (filterBy){
        params.tagged = filterBy.replace(/\s/g, ";");
      }
      return params;
    },

    /**
      * Create a object with the params needed to load more questions
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @param {string} last_request Timestamp of the last element in the timeline.
      * @return {object} "{access_token:"value", key: "value", site: "value",
      *                   sort:"activity", ord:"desc", [tagged: "filterBy"]}"
      */
    _composeLoadmoreParams: function(access_token, key, site, filterBy, last_request){
      var params = {access_token: access_token, key: key, site: site,
                    sort:"activity", order:"desc",
                    max: last_request};
      if (filterBy){
        params.tagged = filterBy.replace(/\s/g, ";");
      }
      return params;
    },

    /**
      * Check when the user want filter the questions by tags
      * @param {object} event Event that produce the search action.
      */
    _filterBy: function(event){
      if (event.type === "keyup" && event.which === 13 || event.type === "click") {
        this.$.panel.style.cursor = "wait";
        this.$.requestEvent.generateRequest();
      }

    },

    /**
      * Observe when the user change the tab selected
      */
    _requestNewContent: function(newValue, oldValue){
      if (oldValue !== undefined) {
        this.$.panel.style.cursor = "wait";
        this.$.requestEvent.generateRequest();
      }
    },

    /**
      *  Open the search bar
      */
    openSearch: function(){
      this.$.searchBar.hidden = false;
      if (this.$.searchBar.hidden == false) {
        this.$.searchBar.focus();
      }
    },

    /**
      * Close the search bar if there are no tags in the input.
      */
    closeSearch: function(e){
      if (e.detail && !this.filterBy) {
        this.$.searchBar.hidden = true;
      }
    },

    // AUXILIAR FUNCTION
    /**
      * Check if the first param is equals to second param
      */
    _compareTo: function(item, item2){
      item2 = item2 == "false"? false: item2;
      item2 = item2 == "true"? true: item2;
      return item === item2;
    },


    /**
      * Decode html encode to utf8 string
      *
      * @param {string} str_data The string with html encode characters
      * @return {string} String codify as utf-8
      */
    _decode_utf8: function(str_data) {
      if (str_data){ 
        str_data = str_data.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
        var matched = str_data.match(/&#([0-9]*);/);
        while(matched) {
          str_data = str_data.replace(/&#[\d]*;/, String.fromCharCode(matched[1]))
          matched = str_data.match(/&#([0-9]*);/);
        }
      }
      return str_data;
    },

    /**
      * Convert the events timestamp to human readble date
      *
      */
    _changeTime: function(){
      for (i=0;i<this.events.length;i++){
        var date = new Date(this.events[i].last_activity_date * 1000);
        var current_date = new Date();
        var time;
        /* Years */
        if ((current_date.getFullYear() - date.getFullYear()) != 0) {
          var dif = current_date.getFullYear() - date.getFullYear()
          time = dif==1 ? dif + " " + this.data.year : dif + " " + this.data.years;
          /* Months */
        } else if ((current_date.getMonth() - date.getMonth()) != 0) { 
          var dif = current_date.getMonth() - date.getMonth();
          time = dif==1 ? dif + " " + this.data.month : dif + " " + this.data.months;
          /* Days */
        } else if((current_date.getDate() - date.getDate()) == 0 ){
          if((current_date.getHours() - date.getHours()) == 0 ){
            if( (current_date.getMinutes() - date.getMinutes()) == 0 ){
              time = current_date.getSeconds() - date.getSeconds();
              time += time == 1? " second": " seconds";
            }
            else{
              time = current_date.getMinutes() - date.getMinutes();
              time += time == 1? " minute":  " minutes";
            }
          }
          else{
            if (current_date.getHours() - date.getHours() == 1) {
              time = current_date.getHours() - date.getHours()+" hour";
            }else {
              time = current_date.getHours() - date.getHours()+" hours";
            }
          }
        }
        else if( ((current_date.getDate() - date.getDate()) < 8) && ( (current_date.getDate() - date.getDate()) > 0)){
          if( (current_date.getDate() - date.getDate()) == 1){
            time = current_date.getDate() - date.getDate()+" day";
          }
          else{
            time = current_date.getDate() - date.getDate()+" days";
          }
        }
        else{
          var month = ["jan","feb","mar","apr", "may","jun","jul","aug","sep","oct","nov","dec"];
          time = date.getDate()+" "+month[date.getMonth()] + ". "+date.getFullYear();
        }
        this.set("events." + i + ".date", time);
      }
    },

  });

</script>
