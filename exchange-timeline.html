<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../paper-button/paper-button.html">


<!--
An element providing the interface for any site of exchanges

Example:
```
<exchange-timeline access_token="user_access_token" key="your_app_key"
site="stackoverflow.com">
</exchange-timeline>
```
Custom property | Description | Default
----------------|-------------|----------
`--exchange-timeline-width` | Width of the element. | `450px`
`--exchange-timeline-height` | Height of the element. | `400px`
`--exchange-timeline-font-family` | Font type of the element. | `Roboto`
`--exchange-timeline-header-color` | Color of the header  | `--paper-grey-800`
`--exchange-timeline-header` | Mixin applied to the header | `{}`
`--exchange-timeline-title-height` | Height of the logo img | `45px`
`--exchange-timeline-title-width` | Width of the logo img | `200px`


@group Timeline Elements
@element exchange-timeline
@demo demo/index.html
@hero stackoverflow-icon.png
-->
<dom-module id="exchange-timeline">

  <template>
    <style is="custom-style">
      :host {
        display: block;
        width: var(--exchange-timeline-width, 450px);
        height: var(--exchange-timeline-height, 400px);
        font-family: var(--exchange-timeline-font-family, Roboto)
      }
      #panel{
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
        background-color: var(--paper-grey-200);
        border-radius: 2px;
      }
      #panel .paper-header {
        background-color: var(--exchange-timeline-header-color, --paper-grey-800);
        color: white;
        padding:15px 8px;
        @apply(--exchange-timeline-header)
          }
      #panel .paper-header .title{
        background: url('image/se-logo.png') no-repeat;
        background-size: contain;
        height: var(--exchange-timeline-title-height, 25px);
        width: var(--exchange-timeline-title-width, 25px);
        margin:auto 0px;
      }
      #panel .paper-header .user_information,
      #panel .paper-header .user_information .image{
        margin:auto 5px;
        font-size:12px;
      }
      #panel .paper-header .user_information .badge[count="0"] {
        display:none;
      }
      #panel .paper-header .user_information .badge .icon {
        border-radius: 50%;
        width: 5px;
        height: 5px;
        margin:auto 5px;
      }
      #panel .paper-header .user_information .badge .icon.bronze{
        background-color: #DBC27E;
      }
      #panel .paper-header .user_information .badge .icon.silver {
        background-color: silver;
      }
      #panel .paper-header .user_information .badge .icon.gold {
        background-color: gold;
      }
      #panel .paper-header .user_information .reputation {
        margin: auto 8px;
      }
      paper-icon-button[prefix] {
        color: black;
      }
      .logo span {
        margin:auto 3px;
      }
      #panel .content {
        margin:15px 8px;
      }
      #panel .post {
        padding:6px 8px;
        background-color:white;        
      }
      .status {
        min-width: 38px;
        height: 38px;
        margin:auto;
        margin-right: 10px;
        padding: 5px;
        text-align: center;
        font-size:10px;
      }
      .status p {
        margin:auto;
      }
      .answer {
        background-color: #75845c;
      }
      .answer[answered] {
        color:gold;
      }
      .answer[count="0"] {
        background-color:inherit;
      }
      .postInfo .title {
        font-size: 14px;
        margin-bottom:20px;
      }
      .additionalInfo{
        font-size: 10px;
        max-height: 16px;
        overflow-y: hidden;
      }
      .additionalInfo .tag {
        padding:3px;
        background-color: #e1ecf4;
        color: #39739d;
        display: inline-block;
      }
      .additionalInfo .tag:hover {
        background-color:#dae7f1;
        cursor:pointer;
      }
      a {
        text-decoration: none;
      }
      .link {
        color: #005999

      }
      .link:hover {
        color: #07c;
      }
      p {
        margin:auto;
      }
      .loadmore paper-material{
        margin-bottom: 15px;
        background-color: var(--paper-grey-400);
      }
      .loadmore paper-material:hover {
        background-color: var(--paper-grey-500);

      }
      #panel .content.error .post {
        padding:25px 8px;
      }

    </style>

    <iron-ajax
               url="https://api.stackexchange.com/2.2/me/questions"
               params="{{_requestEventsParams}}"
               handle-as="json"
               on-response="_handlerRequestEvent"
               on-error="_handlerRequestError"
               id="requestEvent">

    </iron-ajax>

    <iron-ajax url="https://api.stackexchange.com/2.2/me"
               params="{{_requestUserInfo}}"
               handle-as="json"
               on-response="_handlerRequestInfo"
               on-error="_handlerRequestError"
               id="requestInfo"
               auto
               >
    </iron-ajax>
    <iron-ajax url="https://api.stackexchange.com/2.2/me/questions"
               params="{{_requestLoadmoreParams}}"
               handle-as="json"
               on-response="_handlerLoadmoreEvent"
               on-error="_handlerRequestError"
               id="loadmoreEvent"
               >
    </iron-ajax>
    <audio id="audio">
      <source src="audio.mp3" type="audio/mp3">
    </audio>
    <p id="pause" on-click="play">play</p>
    <p id="play" on-click="parar">PAUSEE</p>
    <paper-header-panel id="panel" mode="waterfall" class="blue">

      <!-- TIMELINE HEADER-->
      <div class="paper-header horizontal layout">
        <!-- LOGO stack exchange icon -->
        <div class="flex horizontal layout logo">
          <div class="title"></div>
          <span> Stack Exchange</span>
        </div>

        <!-- USER INFORMATION-->
        <div class="user_information horizontal layout">
          <!-- USER image-->
          <iron-icon class="image" src="{{user.profile_image}}"></iron-icon>
          <!-- USER name-->
          <p class="username">{{user.display_name}}</p>
          <!-- USER reputation -->
          <p class="reputation">{{user.reputation}}</p>

          <!--  BADGES -->
          <!-- gold-->
          <div class="badge horizontal layout" count$="{{user.badge_counts.gold}}">
            <div class="gold icon"></div>
            <p>{{user.badge_counts.gold}}</p>
          </div>

          <!-- silver-->
          <div class="badge horizontal layout" count$="{{user.badge_counts.silver}}">
            <div class="silver icon"></div>
            <p>{{user.badge_counts.silver}}</p>
          </div>

          <!-- bronze-->
          <div class="badge horizontal layout" count$="{{user.badge_counts.bronze}}">
            <div class="bronze icon"></div>
            <p>{{user.badge_counts.bronze}}</p>
          </div>
        </div>

        <!-- REFRESH ICON -->
        <div><paper-icon-button icon="refresh" on-click="refresh"></paper-icon-button></div>
      </div>

      <!-- TIMELINE BODY -->
      <!-- Check if an error happened -->
      <template is="dom-if" if="{{_compareTo(request_error, 'false')}}">
        <!-- CONTENT INFO-->
        <template is="dom-repeat" items="{{events}}">
          <paper-material elevation=1 class="content">
            <div class="post horizontal layout">
              <!-- ANSWERS -->
              <div count$="{{item.answer_count}}" answered$="{{item.is_answered}}" class="answer status vertical center-justified layout">
                <p>{{item.answer_count}}</p>
                <p>answer</p>
              </div>
              <!-- POSTINFO -->
              <div class="postInfo vertical layout flex">
                <!-- TITLE -->
                <div class="title flex">
                  <a href="{{item.link}}" target="_blank" class="link">{{_decode_utf8(item.title)}}</a>
                </div>
                <!-- TAGS AND TIME -->
                <div class="additionalInfo horizontal layout">
                  <div class="tags flex">
                    <template is="dom-repeat" items="{{item.tags}}">
                      <span class="link tag">{{item}}</span>
                    </template>
                  </div>
                  <div class="time">
                    <p>{{item.date}}
                      <a href="{{item.owner.link}}" class="link" target="_blank"> {{_decode_utf8(item.owner.display_name)}}</a >
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </paper-material>
        </template>
        <template is="dom-if" if="{{_compareTo(events.length, 0)}}">
          <paper-material elevation=1 class="content loadmore">
            <div class="post vertical layout" id="not_found">
              <p>Opss!! There are not results for <b>{{not_found}}</b> tag[s].</p> 
              <p>Try it with other[s]</p>
            </div>
          </paper-material>
        </template>
        <!-- Show more button -->
        <template is="dom-if" if="{{has_more}}">
          <div class="horizontal center-justified layout loadmore" id="loadmore">
            <paper-material elevation="2">
              <paper-button on-click="loadmore">Load More</paper-button>
            </paper-material>
          </div>
        </template>
      </template> <!-- /Check error -->
      <template is="dom-if" if="{{request_error}}">
        <paper-material elevation=1 class="content error">
          <div class="post vertical center layout" id="error">
            <p>An error ocurred. Plase try it later</p> 
            <p>Sorry for the inconveniences</p>
          </div>
        </paper-material>
      </template>
    </paper-header-panel>
  </template>


</dom-module>

<script>

  Polymer({

    is: 'exchange-timeline',

    properties: {

      /**
       * `access_token` that permit read information about the user. 
       */
      access_token: {
        type: String,
        reflectToAttribute: true
      },

      /**
        * `key` is your app key on Stack Exchange. 
        */
      key: {
        type: String,
        reflectToAttribute: true
      },
      /**
        * `site` where the timeline will get information. E.g: stackoverflow.com
        */
      site: {
        type:String,
        reflectToAttribute: true
      },

      /**
        * compose the request param when it will get information
        * about the user
        */
      _requestEventsParams: {
        type: Object,
        computed: "_composeRequestParams(access_token, key, site)"
      },

      /**
        * compose the user request params
        */
      _requestUserInfo: {
        type: Object,
        computed: "_composeUserInfo(access_token, key, site)"
      },

      /**
        * compose the refresh params when the user want load more data.
        */
      _requestLoadmoreParams: {
        type: Object,
        computed: "_composeLoadmoreParams(access_token, key, site, page)"
      },

      request_error: {
        type: Boolean,
        value: false
      },
      page: {
        type: Number,
        value: 1
      }
    },

    // Element Lifecycle
    parar: function(){
      this.$.audio.play();
    },
    play: function(){
      this.$.audio.pause();
    },
    ready: function() {
      if(this._requestEventsParams){
        this.$.panel.style.cursor = "wait";
        this.$.requestEvent.generateRequest();
      }
    },

    /**
     * The `exchange-timeline-eventsReady` event is fired whenever new events are loaded.
     *
     * @event exchange-timeline-eventsReady
     * @detail {{sound: String}} 
     */

    /**
      * Handler the questions response.
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerRequestEvent: function(event, detail){
      this.$.panel.style.cursor = "";
      this.fire("exchange-timeline-eventsReady", detail);
      this.request_error = false;
      // set new events
      this.events = detail.response.items;
      // Check if there are more questions
      this.has_more = detail.response.has_more;
      // If there're no matches, store the filter value
      if (this.events.length === 0) {
        this.not_found = this.filterBy;
      }
      // Change timestamp to human readable
      this._changeTime();
    },

    _handlerRequestError: function(event, detail) {
      this.$.panel.style.cursor = "";
      this.fire("exchange-timeline-errorRequest", {detail:detail});
      this.request_error = true; 
    },

    /**
      * Refresh the information showed in the timeline. It recalculate
      * the time field and it add the new post.
      * NOTE: when sthe component is reloaded, it only show the first 30 post
      * a pesar de haber cargado más
      */
    refresh: function(){
      this.$.panel.style.cursor = "wait";
      this.page = 1;
      this.$.requestEvent.generateRequest();
    },

    /**
      * Request more data to the API and show it in the timeline.
      */
    loadmore: function(){
      if (this.has_more) {
        this.page++;
        this.$.panel.style.cursor = "wait";
        this.$.loadmoreEvent.generateRequest();
      }
    },

    /**
      * Handler the user information response.
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerRequestInfo: function(event, detail) {
      this.user = detail.response.items[0];
    },

    /**
      * Handler the load more response.
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerLoadmoreEvent: function(event, detail) {
      this.request_error = false;
      this.$.panel.style.cursor = "";
      for (var i = 0; i < detail.response.items.length;i++) {
        this.push('events', detail.response.items[i]);
      }
      this._changeTime();
    },

    /**
      * Create a object with the params needed to request new questions
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @return {object} "{access_token:"value", key: "value", site: "value",
      *                   sort:"activity", order:"desc"}"
      */
    _composeRequestParams: function(access_token, key, site) {

      return {access_token: access_token, key: key, site: site};
    },

    /**
      * Choose the endpoint depend on the tab selected.
      * @param {Number} selected Tab number selected.
      * @return {string}  Endpoint where it must request the data.
      */
    _composeRequestUrl: function(selected) {
      return "https://api.stackexchange.com/2.2/me/questions"
    },

    /**
      * Create a object with the params needed to request refresh
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @param {string} first_request Timestamp of the first element in the timeline.
      * @return {object} "{access_token:"value", key: "value", site: "value",
      *                   sort:"activity", order:"desc"}"
      */
    _composeUserInfo: function(access_token, key, site){
      return {access_token: access_token, key: key, site: site};
    },

    /**
      * Create a object with the params needed to load more questions
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @param {string} page Page of the request
      * @return {object} "{access_token:"value", key: "value", site: "value",
      *                   sort:"activity", ord:"desc"}"
      */
    _composeLoadmoreParams: function(access_token, key, site, page){
      return {access_token: access_token, key: key, site: site, page:this.page};
    },

    /**
      * Check when the user want filter the questions by tags
      * @param {object} event Event that produce the search action.
      */
    _filterBy: function(event){
      if (event.type === "keyup" && event.which === 13 || event.type === "click") {
        this.$.panel.style.cursor = "wait";
        this.$.requestEvent.generateRequest();
      }

    },

    /**
      * Observe when the user change the tab selected
      */
    _requestNewContent: function(newValue, oldValue){
      if (oldValue !== undefined) {
        this.$.panel.style.cursor = "wait";
        this.$.requestEvent.generateRequest();
      }
    },

    // AUXILIAR FUNCTION
    /**
      * Check if the first param is equals to second param
      */
    _compareTo: function(item, item2){
      item2 = item2 == "false"? false: item2;
      item2 = item2 == "true"? true: item2;
      return item === item2;
    },


    /**
      * Decode html encode to utf8 string
      *
      * @param {string} str_data The string with html encode characters
      * @return {string} String codify as utf-8
      */
    _decode_utf8: function(str_data) {
      if (str_data){ 
        str_data = str_data.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
        var matched = str_data.match(/&#([0-9]*);/);
        while(matched) {
          str_data = str_data.replace(/&#[\d]*;/, String.fromCharCode(matched[1]))
          matched = str_data.match(/&#([0-9]*);/);
        }
      }
      return str_data;
    },

    /**
      * Convert the events timestamp to human readble date
      *
      */
    _changeTime: function(){
      for (i=0;i<this.events.length;i++){
        var date = new Date(this.events[i].last_activity_date * 1000);
        var current_date = new Date();
        var time;
        /* Years */
        if ((current_date.getFullYear() - date.getFullYear()) != 0) {
          var dif = current_date.getFullYear() - date.getFullYear()
          time = dif==1 ? dif + " year" : dif + " years";
          /* Months */
        } else if ((current_date.getMonth() - date.getMonth()) != 0) { 
          var dif = current_date.getMonth() - date.getMonth();
          time = dif==1 ? dif + " month" : dif + " months";
          /* Days */
        } else if((current_date.getDate() - date.getDate()) == 0 ){
          if((current_date.getHours() - date.getHours()) == 0 ){
            if( (current_date.getMinutes() - date.getMinutes()) == 0 ){
              time = current_date.getSeconds() - date.getSeconds();
              time += time == 1? " second": " seconds";
            }
            else{
              time = current_date.getMinutes() - date.getMinutes();
              time += time == 1? " minute":  " minutes";
            }
          }
          else{
            if (current_date.getHours() - date.getHours() == 1) {
              time = current_date.getHours() - date.getHours()+" hour";
            }else {
              time = current_date.getHours() - date.getHours()+" hours";
            }
          }
        }
        else if( ((current_date.getDate() - date.getDate()) < 8) && ( (current_date.getDate() - date.getDate()) > 0)){
          if( (current_date.getDate() - date.getDate()) == 1){
            time = current_date.getDate() - date.getDate()+" day";
          }
          else{
            time = current_date.getDate() - date.getDate()+" days";
          }
        }
        else{
          var month = ["jan","feb","mar","apr", "may","jun","jul","aug","sep","oct","nov","dec"];
          time = date.getDate()+" "+month[date.getMonth()] + ". "+date.getFullYear();
        }
        this.set("events." + i + ".date", time);
      }
    },

  });

</script>
