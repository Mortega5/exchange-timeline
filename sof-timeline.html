<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">


<!--
An element providing a solution to no problem in particular.

Example:

<sof-timeline></sof-timeline>

@group Seed Elements
@element sof-timeline
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="sof-timeline">

  <template>
    <style is="custom-style">
      :host {
        display: block;
        width: var(--google-timeline-width, 450px);
        height: var(--google-timeline-height, 400px);
        font-family: var(--google-timeline-font-family, Roboto)
      }
      #panel{
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
        background-color: var(--paper-grey-200);
        border-radius: 2px;
      }
      #panel .paper-header {
        background-color: var(--paper-brown-800);
        color: white;
        padding:5px 8px;
        @apply(--google-timeline-header)
          }
      #panel .paper-header .title{
        background: url('http://sstatic.net/stackexchange/img/logos/se/se-logo.png?v=dd7153fcc7fa') no-repeat;
        background-size: contain;
        height: var(--google-timeline-title-height, 45px);
        margin:auto;
      }
      #panel .content {
        margin:15px 8px;
      }
      #panel .post {
        padding:6px 8px;
        background-color:white;        
      }
      .status {
        min-width: 38px;
        height: 38px;
        margin:3px;
        padding: 5px;
        text-align: center;
        font-size:10px;
      }
      .status p {
        margin:auto;
      }
      .status[answered=true] {
        background-color: darkgreen;
      }
    </style>

    <iron-ajax
               url="https://api.stackexchange.com/2.2/questions"
               params="{{_requestEventsParams}}"
               handle-as="json"
               on-response="_handlerRequestEvent"
               id="requestEvent">

    </iron-ajax>
    <paper-header-panel id="panel" mode="waterfall" class="blue">
      <div class="paper-header horizontal layout">
        <div class="title flex"></div>
        <div><paper-icon-button icon="refresh" on-click="refresh"></paper-icon-button></div>
      </div>
      <!-- CONTENT INFO-->
      <template is="dom-repeat" items="{{events}}">
        <paper-material elevation=1 class="content">
          <div class="post horizontal layout">
            <div class="votes status vertical center-justified layout">
              <p>{{item.score}}</p>
              <p>votes</p>
            </div>
            <div answered="{{_test(item.is_answered)}}" class="answer status vertical center-justified layout">
              <p>{{item.answer_count}}</p>
              <p>answer</p>
            </div>
            <div class="views status vertical center-justified layout">
              <p>{{item.view_count}}</p>
              <p>views</p>
            </div>
            <div class="postInfo vertical layout flex">
              <div class="title">
                <span>Title</span>
              </div>
              <div class="additionalInfo horizontal layout">
                <div class="tags flex">
                  <span>tags</span>
                  <span>tag2</span>
                </div>
                <div class="time">
                  <span>answered 1 min ago...</span>
                </div>
              </div>
            </div>
            <div></div>
          </div>
        </paper-material>
      </template>
    </paper-header-panel>
  </template>


</dom-module>

<script>

  Polymer({

    is: 'sof-timeline',

    properties: {

      /**
       * `access_token` that permit read information about the user
       */
      access_token: {
        type: String,
        reflectToAttribute: true
      },
      /**
        * `key` is your key on StackOverFlow
        */
      key: {
        type: String,
        reflectToAttribute: true
      },
      /**
        * `site` TODO
        */
      site: {
        type:String,
        reflectToAttribute: true
      },
      /**
        * `_requestEventsParams` TODO
        */
      _requestEventsParams: {
        type: String,
        computed: "_composeRequestParams(access_token, key, site)"
      },

      /**
       * Describes the author of the element, but is really just an excuse to
       * show off JSDoc annotations.
       *
       * @type {{name: string, image: string}}
       */
      author: {
        type: Object,
        // Use `value` to provide a default value for a property, by setting it
        // on your element's prototype.
        //
        // If you provide a function, as we do here, Polymer will call that
        // _per element instance_.
        //
        // We do that to ensure that each element gets its own copy of the
        // value, rather than having it shared across all instances (via the
        // prototype).
        value: function() {
          return {
            name:  'Dimitri Glazkov',
            image: 'http://addyosmani.com/blog/wp-content/uploads/2013/04/unicorn.jpg',
          };
        }
      },

    },

    // Element Lifecycle

    ready: function() {
      if(this._requestEventsParams){
        this.$.requestEvent.generateRequest();
      }
    },

    // Ajax request handler

    /**
     * The `sof-timeline-eventsReady` event is fired whenever new events are loaded.
     *
     * @event sof-timeline-eventsReady
     * @detail {{sound: String}} 
     */

    /**
      * TODO
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerRequestEvent: function(event, detail){
      this.fire("sof-timeline-eventsReady", detail);
      this.events = detail.response.items;
    },

    _test: function(a){
      console.log(a);
      return true;
    },


    /**
      * TODO Breaf description of `_componseRequestParam`
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @return {object} {access_token:"value", key: "value", site: "value"}
      */
    _composeRequestParams: function(access_token, key, site) {
      return {access_token: access_token, key: key, site: site};
    },

    _decode_utf8: function(str_data) {
      var matched = str_data.match(/&#([0-9]*);/);
      while(matched) {
        str_data = str_data.replace(/&#[\d]*;/, String.fromCharCode(matched[1]))
        matched = str_data.match(/&#([0-9]*);/);
      }
      return str_data;
    },
    /**
     * Sometimes it's just nice to say hi.
     *
     * @param {string} greeting A positive greeting.
     * @return {string} The full greeting.
     */
    sayHello: function(greeting) {
      var response = greeting || 'Hello World!';
      return 'sof-timeline says, ' + response;
    },

    /**
     * Attempt to destroy this element's enemies with a beam of light!
     *
     * Or, at least, dispatch an event in the vain hope that someone else will
     * do the zapping.
     */
    fireLasers: function() {
      this.fire('sof-timeline-lasers', {sound: 'Pew pew!'});
    }

  });

</script>
