<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">


<!--
An element providing a solution to no problem in particular.

Example:

<sof-timeline></sof-timeline>

@group Seed Elements
@element sof-timeline
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="sof-timeline">

  <template>
    <style is="custom-style">
      :host {
        display: block;
        width: var(--sof-timeline-width, 650px);
        height: var(--sof-timeline-height, 400px);
        font-family: var(--sof-timeline-font-family, Roboto)
      }
      #panel{
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14), 0 1px 10px 0 rgba(0, 0, 0, 0.12), 0 2px 4px -1px rgba(0, 0, 0, 0.4);
        background-color: var(--paper-grey-200);
        border-radius: 2px;
      }
      #panel .paper-header {
        background-color: var(--sof-timeline-header-color, --paper-brown-800);
        color: white;
        padding:5px 8px;
        @apply(--sof-timeline-header)
          }
      #panel .paper-header .title{
        background: url('http://sstatic.net/stackexchange/img/logos/se/se-logo.png?v=dd7153fcc7fa') no-repeat;
        background-size: contain;
        height: var(--sof-timeline-title-height, 45px);
        width: var(--sof-timeline-title-width, 200px);
        margin:auto 0px;
      }
      #panel .paper-header .searchBar {
        --paper-input-container-color: #eee;
        --paper-input-container-input: {
          color: #eee;
        }
        position:absolute;
        top:0;
        left:0;
        right: 0;
        height: var(--sof-timeline-title-height);
        background-color: var(--paper-brown-800);
        z-index:1000;
      }
      paper-icon-button[prefix] {
        color: black;
      }
      #panel .content {
        margin:15px 8px;
      }
      #panel .post {
        padding:6px 8px;
        background-color:white;        
      }
      .status {
        min-width: 38px;
        height: 38px;
        margin:auto;
        margin-right: 10px;
        padding: 5px;
        text-align: center;
        font-size:10px;
      }
      .status p {
        margin:auto;
      }
      .answer {
        background-color: #75845c;
      }
      .answer[answered] {
        color:gold;
      }
      .answer[count="0"] {
        background-color:inherit;
      }
      .postInfo .title {
        font-size: 14px;
        margin-bottom:20px;
      }
      .additionalInfo{
        font-size: 10px;
        max-height: 16px;
        overflow-y: hidden;
      }
      .additionalInfo .tag {
        padding:3px;
        background-color: #e1ecf4;
        color: #39739d;
        display: inline-block;
      }
      .additionalInfo .tag:hover {
        background-color:#dae7f1;
        cursor:pointer;
      }
      a {
        text-decoration: none;
      }
      .link {
        color: #005999

      }
      .link:hover {
        color: #07c;
      }
      p {
        margin:auto;
      }
      /* No funcionan las medias queries porque no se aplican sobre el host sino sobre toda la pantalla
      * utilizar toggleClass(nombreClase, booleano, [nodo]) para modificar en funcion del tamaÃ±o
      */
      @media screen (max-width: 500px){
        .votes, .views, .time > p > span{
          display: none !important;
        }
      }
      paper-tabs{
        height: 40px;
        font-size: 12px;
        --paper-tabs-selection-bar-color: var(--paper-orange-700);
      }
      paper-tab {
        --paper-tab-ink: var(--paper-blue-700);
      }
    </style>

    <iron-ajax
               url="{{_requestEventsUrl}}"
               params="{{_requestEventsParams}}"
               handle-as="json"
               on-response="_handlerRequestEvent"
               id="requestEvent">

    </iron-ajax>
    <paper-header-panel id="panel" mode="waterfall" class="blue">
      <div class="paper-header horizontal layout">
        <div class="title flex"></div>
        <paper-input hidden label="search tags (separate them with whitespaces)" class="flex searchBar" id="searchBar" no-label-float value="{{searchBy::bind-value-changed}}" on-keyup="_searchBy" on-blur="_closeSearch">
          <paper-icon-button icon="search" on-click="_searchBy" prefix></paper-icon-button>
        </paper-input>
        <paper-icon-button icon="search" on-click="_openSearch"></paper-icon-button>
        <div><paper-icon-button icon="refresh" on-click="refresh"></paper-icon-button></div>
      </div>
      <paper-tabs selected="{{tabSelected}}">
        <paper-tab>Last General Questions</paper-tab>
        <paper-tab>Your Questions</paper-tab>
      </paper-tabs>
      <!-- CONTENT INFO-->
      <template is="dom-repeat" items="{{events}}">
        <paper-material elevation=1 class="content">
          <div class="post horizontal layout">
            <!-- VOTES -->
            <div class="votes status vertical center-justified layout">
              <p>{{item.score}}</p>
              <p>votes</p>
            </div>
            <!-- ANSWERS -->
            <div count$="{{item.answer_count}}" answered$="{{item.is_answered}}" class="answer status vertical center-justified layout">
              <p>{{item.answer_count}}</p>
              <p>answer</p>
            </div>
            <!-- VIEWS -->
            <div class="views status vertical center-justified layout">
              <p>{{item.view_count}}</p>
              <p>views</p>
            </div>
            <!-- POSTINFO -->
            <div class="postInfo vertical layout flex">
              <!-- TITLE -->
              <div class="title flex">
                <a href="{{item.link}}" target="_blank" class="link">{{_decode_utf8(item.title)}}</a>
              </div>
              <!-- TAGS AND TIME -->
              <div class="additionalInfo horizontal layout">
                <div class="tags flex">
                  <template is="dom-repeat" items="{{item.tags}}">
                    <span class="link tag">{{item}}</span>
                  </template>
                </div>
                <div class="time">
                  <p><span>answered</span> {{_timeSince(item.last_activity_date)}}
                    <a href="{{item.owner.link}}" class="link" target="_blank"> {{_decode_utf8(item.owner.display_name)}}</a >
                  </p>
                </div>
              </div>
            </div>
          </div>
        </paper-material>
      </template>
      <template is="dom-if" if="{{_checkArraySize(events, 0)}}">
        <paper-material elevation=1 class="content">
          <div class="post vertical layout">
            <p>Opss!! There are not results for <b>{{not_found}}</b> tag[s].</p> 
            <p>Try it with other[s]</p>
          </div>
        </paper-material>
      </template>
    </paper-header-panel>
  </template>


</dom-module>

<script>

  Polymer({

    is: 'sof-timeline',

    properties: {

      /**
       * `access_token` that permit read information about the user
       */
      access_token: {
        type: String,
        reflectToAttribute: true
      },
      /**
        * `key` is your key on StackOverFlow
        */
      key: {
        type: String,
        reflectToAttribute: true
      },
      /**
        * `site` TODO
        */
      site: {
        type:String,
        reflectToAttribute: true
      },
      _requestEventsUrl: {
        type: String,
        computed: "_composeRequestUrl(tabSelected)"
      },
      /**
        * `_requestEventsParams` TODO
        */
      _requestEventsParams: {
        type: String,
        computed: "_composeRequestParams(access_token, key, site, searchBy)"
      },
      searchBy: {
        type: String,
        value: ""
      },
      tabSelected: {
        type: Number,
        value: 0,
        observer: "_requestNewContent" 
      },
      /**
       * Describes the author of the element, but is really just an excuse to
       * show off JSDoc annotations.
       *
       * @type {{name: string, image: string}}
       */
      author: {
        type: Object,
        value: function() {
          return {
            name:  'Dimitri Glazkov',
            image: 'http://addyosmani.com/blog/wp-content/uploads/2013/04/unicorn.jpg',
          };
        }
      },

    },

    // Element Lifecycle

    ready: function() {
      if(this._requestEventsParams){
        this.$.requestEvent.generateRequest();
      }
    },

    // Ajax request handler

    /**
     * The `sof-timeline-eventsReady` event is fired whenever new events are loaded.
     *
     * @event sof-timeline-eventsReady
     * @detail {{sound: String}} 
     */

    /**
      * TODO
      *
      * @param {object} event Object returned by ajax request
      * @param {object} detail Detail of response returned by ajax request
      * 
      */
    _handlerRequestEvent: function(event, detail){
      this.fire("sof-timeline-eventsReady", detail);
      this.events = detail.response.items;
      if (this.events.length === 0) {
        this.not_found = this.searchBy;
      }
    },

    /**
      * TODO Breaf description of `_componseRequestParam`
      * @param {string} access_token The user access token provide as parameter
      * @param {string} key SE key provided as parameter 
      * @param {string} site URL provided as parameter
      * @return {object} {access_token:"value", key: "value", site: "value"}
      */
    _composeRequestParams: function(access_token, key, site, searchBy) {
      return {access_token: access_token, key: key, site: site, tagged: searchBy.replace(/\s/g, ";"), sort:"activity", order:"desc"};
    },
    /**
      * TODO `_composeRequestUrl`
      */
    _composeRequestUrl: function(selected) {
      return selected == 0 ? "https://api.stackexchange.com/2.2/questions": "https://api.stackexchange.com/2.2/me/questions"
    },
    /**
      * TODO `_searchBy`
      */
    _searchBy: function(event){
      if (event.type === "keyup" && event.which === 13 || event.type === "click") {
        this.$.requestEvent.generateRequest();
      }

    },
    /**
      * TODO `_requestNewContent
      */
    _requestNewContent: function(newValue, oldValue){
      if (oldValue !== undefined) {
        this.$.requestEvent.generateRequest();
      }
    },
    /**
    * TODO `_openSearch`
    */
    _openSearch: function(){
      this.$.searchBar.hidden = false;
      if (this.$.searchBar.hidden == false) {
        this.$.searchBar.focus();
      }
    },
    /**
      * TODO `_closeSearch`
      */
    _closeSearch: function(e){
      if (e.detail && !this.searchBy) {
        this.$.searchBar.hidden = true;
      }
    },
    _checkArraySize: function(array, size){
      return array.length === size;
    },
    /**
      * Decode html encode to utf8 string
      *
      * @param {string} str_data The string with html encode characters
      * @return {string} String codify as utf-8
      */
    _decode_utf8: function(str_data) {
      str_data = str_data.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
      var matched = str_data.match(/&#([0-9]*);/);
      while(matched) {
        str_data = str_data.replace(/&#[\d]*;/, String.fromCharCode(matched[1]))
        matched = str_data.match(/&#([0-9]*);/);
      }
      return str_data;
    },
    /**
      * TODO
      *
      */
    _timeSince: function(timestamp){
      var date = new Date(timestamp * 1000);
      var current_date = new Date();
      var time;
      if((current_date.getDate() - date.getDate()) == 0 ){
        if((current_date.getHours() - date.getHours()) == 0 ){
          if( (current_date.getMinutes() - date.getMinutes()) == 0 ){

            time = current_date.getSeconds() - date.getSeconds();
            time += time == 1? " second ago" : " seconds ago";
          }
          else{
            time = current_date.getMinutes() - date.getMinutes();
            time += time == 1? " minute ago" :  " minutes ago";
          }
        }
        else{
          if (current_date.getHours() - date.getHours() == 1) {
            time = current_date.getHours() - date.getHours()+" hour ago";
          }else {
            time = current_date.getHours() - date.getHours()+" hours ago";
          }
        }
      }
      else if( ((current_date.getDate() - date.getDate()) < 8) && ( (current_date.getDate() - date.getDate()) > 0)){
        if( (current_date.getDate() - date.getDate()) == 1){
          time = current_date.getDate() - date.getDate()+" day ago";
        }
        else{
          time = current_date.getDate() - date.getDate()+" days ago";
        }
      }
      else{
        var month = ["Jan","Feb","Mar","Apr", "May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        time = date.getDate()+" "+month[date.getMonth()] + ". "+date.getFullYear();

      }
      return time
    },

  });

</script>
